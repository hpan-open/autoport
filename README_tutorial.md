
# Notes

## Overview - Why Local Ports

**Advantages**

* Optimized `/etc/make.conf`
    * Processor-specific optimizations
    * Debug Options

* Custom Package Configuration

* Institution-Local Licensing for Non-Redistributable Packags
    * e.g. Adobe Flash; Microsoft fonts; 'trial' software in ports

**Some Possible Concerns**

* It may be a time-consuming process, to develop an initial ports
  selection with a set of configuration options that will successfully
  'build' 
    * The time-consuming nature of the ports build process is
      considerably mitigated with the extent of log data produced by
      Poudriere. Build failures can be easily diagnosed with review of
      log files generated by Poudriere. Build failures can be
      addressed with individual port reconfigurations, port updates,
      or in-depth issue tracking onto the prots tree and distfile
      archives.
* Effects of specific port configuration selections may not seem
  immediately obvious. Some configuration options -- for instance, the
  VirtualBox `MANUAL` option   -- when selected, may result in adding
  a substantial number of build dependencies to a port, increasing the
  total build time and "Footprint" of the build. New build
  dependencies may be introduced as by way of immediate dependencies,
  and -- indirectly -- by way of dependencies introduced by immediate
  dependencies.
    * Port configuration options should be carefully reviewed. Short
      of a formal port dependency/buld-depends graph, perhaps an
      intuitive manner of overview may be nonetheless possible as of a
      careful attention to configuration options and effects
      demonstrad at build time.
    * Port build time may be further mitgated when applying the
      compiler cache tool, 'ccache' with Poudriere


**Contextual topics**

* Shell Console
    * `screen`
* FreeBSD `pkgng`
    * Configuring `pkgng`
    * Querying package metadata with `pkg query` and `pkg rquery`
* Software Distribution in FreeBSD
    * FreeBSD Ports
        * Ports and Software Licensing
    * FreeBSD Base System
    * FreeBSD Kernel
* FreeBSD Process Jails
    * Jail Configuration and Management with `ezjail`
* Poudriere
    * Poudriere Configuration
    * Poudriere _reference jail_ (build-time jail)
    * Metadata Generated by Poudriere


## Topic: Poudriere Metadata

## Procedure : Create Local Jail for Initial Port Builds, Poudriere Runtime

**References**
* [Managing Jails with ezjail](https://www.freebsd.org/doc/handbook/jails-ezjail.html)
* [ezjail homepage](https://erdgeist.org/arts/software/ezjail/)
* [Appserver Jails HOWTO](https://wiki.freebsd.org/AppserverJailsHOWTO)
* [Run poudriere in a jail](https://github.com/freebsd/poudriere/wiki/poudriere_in_jail)

**Ed. Note:** It may be convenient to use `screen` when administering
a host. See also: port `sysutils/screen`; `screen` TeXinfo pages

**Example: Initialize a `screen` service** as named for the host's _node name_
>     screen -S $(hostname -s)

**Example: Reconnect to a running `screen` service** named for he host's _node name_
>     screen -xr $(hostname -s)

**Ed. Note:** If `/usr/local/poudriere` is mounted as an NFS share in
any peers on the LAN, it may be advisable for the peers to unmount the
share before any packages will be built with Poudriere.

**Ed. Note:** See also, `ccache`, `poudriere.conf` option `CCACHE_DIR`

**Ed. Note:** The following text about ezjail might be a useful
summary, though not going into detail about launching Poudriere from
within the created jail. See also: References

First, **define `lo` as a _cloned interfce** -- configure `rc.conf`
for `cloned_interfaces="lo1"`**, then `service netif cloneup` 

Secondly, **update the system ports tree** (`portsnap`) 

>     cd /usr/src
>     portsnap fetch
>     portsnap update

If needed, **rebuild the system's pkgng**

>     cd /usr/ports/ports-mgmt/pkg
>     make
>     make deinstall
>     make install clean

**Build and install ezjail**

>     cd /usr/ports/sysutils/ezjail
>     make install clean

Optionally, **enable ezjail initialization at boot time, and start
ezjail** -- configure `rc.conf` for `ezjail_enable="YES"` and `service
ezjail start`

**Build the _basejail_** for the host -- to `/usr/jails/fulljail` from
`/usr/src` (as previously a `make installworld` source)

>     ezjail-admin update -i -p

**Ed. note:** _This takes a short while_

**Create a jail for use by Poudriere** (non-ZFS), at `/usr/jails/portjail`

>     ezjail-admin create portjail 'lo1|127.0.0.1,em0|192.168.100.50'

Ed. Note: ... _sshd, ntpd, syslogd_ ... _PF_ ...

**Ed. Note:** ezjail can be useful for managing jails in which to run
Poudriere, albeit perhaps not as useful for managing jails used by
Poudriere for port building.


## Procedure: Simple Local Build Process with Poudriere

**Creating a jail source for Poudriere build-time jails**

**Ed note:** A FreeBSD _base system_ was previously built in `/usr/src`

>     cd /usr/src
>     make installworld DESTDIR=/usr/jails/pjail DB_FROM_SRC=1
>     make distrib-dirs DESTDIR=/usr/jails/pjail DB_FROM_SRC=1
>     make distribution DESTDIR=/usr/jails/pjail DB_FROM_SRC=1


**Initialize the jail with Poudriere**

>     VERSION=$(uname -r)
>     JAILNAME=$(echo $VERSION | sed 's|\.|-|')
>     poudriere jail -c -j ${JAILNAME} -v ${VERSION} -m null -M /usr/jails/pjail

_Ed. Note:_ The jail created in this step will be used as a source for
initializing a Poudriere _reference jail_, at build time

**Initialize a ports tree with Poudriere**, using the 'git' ports method

>     TREENAME="$(hostname -s)"
>     poudriere ports -c -p ${TREENAME} -m git

Ports tree will be cloned to "/usr/local/poudriere/ports/${TREENAME}"

**Ed. note:** _This takes a short while_

**Create a list of packages to build**

>     cat<<EOF>> my.list
>     misc/mmv
>     sysutils/less
>     sysutils/xstow
>     sysutils/screen
>     EOF

**Configure packages from list**

>     poudriere options -p ${TREENAME} -j ${JAILNAME} -f my.list

**Ed. note:** Some configuration options may result in selection of
additional dependencies, thus requiring later configuration dialogues

**Ed. note:** See also `/usr/local/etc/poudriere.d/${JAILNAME}-options/`

**Build Packages from list**, Three parallel builds

>     poudriere bulk -p ${TREENAME} -j ${JAILNAME} -f my.list -J 3 -C

**Ed. note:** distfiles retrieved from `MASTER_SITES` (Provenance)

**Ed. note:** Files will be created at  `"/usr/local/poudriere/data/packages/${JAILNAME}-${TREENAME}"`

**Ed. note:** See also `pkg.conf(5)`

>     mkdir -p /usr/local/etc/pkg/repos
>     REPNAME=${TREENAME}
>     CONF=/usr/local/etc/pkg/repos/${TREENAME}.conf
>     PKGPATH=/usr/local/poudriere/data/packages/${JAILNAME}-${TREENAME}
>     if ! [ -a ${CONF} ]; then
>       cat <<EOF> ${CONF}
>     ${REPNAME} {
>        url: "file://${PKGPATH}"
>        priority: 10
>     }
>     EOF

...

**Option:** Install from list in build log

**Ed note:** In this approach, every package installed will be marked as
_manually installed_. Thus, none of the packages may be subsequently
removed with `pkg autoremove`

>     export ASSUME_ALWAYS_YES=yes
>     PKGS=$(awk '{print $1}' /usr/local/poudriere/data/logs/bulk/${JAILNAME}-${TREENAME}/latest/.poudriere.ports.built)
>     pkg install -f ${PKGS}


**Alternate approach :** Reinstall all packages currently installed
from repository `${REPNAME}`

**Ed note:** Assuming that the `install -f` command may alter some
_packge state_ data as would otherwise be available to `pkg
autoremove`, the following script ensures that the _autoremove_ state
will be restored onto any packages reinstalled with the script

**Ed. note:** FIXME - List sorting/deduplication would be easier in
Lisp. See also: ECL

**Ed. note:** If package dependencies change across the reinstallation
process, the subsequent `pkg set` call might fail.
 
>     export ASSUME_ALWAYS_YES=yes
>     # Set IFS to a custom value, to ensure newlines are not
>     # collapsed to spaces in varibles
>     if [ -v IFS ]; then ORIG_IFS=${IFS}; else unset ORIG_IFS; fi
>     IFS="*"
>     PKGS_IN=$(pkg query '%n')
>     PKGS_AUTO=$(pkg query -e '%a = 1' '%n')
>     PKGS=$({ echo ${PKGS_IN} && pkg rquery -r ${REPNAME} '%n'; }  | sort | uniq -d)
>     PKGS_REAUTO=$({ echo ${PKGS_AUTO} && echo ${PKGS}; } | sort | uniq -d)
>     # Update pkgng Repository Information and Re-Install Packages
>     export PKGS PKGS_REAUTO
>     su
>     pkg update && pkg install -f ${PKGS}
>     # Ensure 'autoremove' flag is still set on original 'autoremove' packages
>     for P in ${PKGS_REAUTO}; do pkg set -A 1 ${P}; done
>     # Reset IFS
>     if [ -v ORIG_IFS ]; then IFS=${ORIG_IFS}; unset ORIG_IFS; else unset IFS; fi

### Resolving Build Failures - Failed and Ignored Builds

**Ed. Note:** Poudriere generates a substantial amount of metadata,
all in a JSON-like format (TBD: JSON Parsing with a BSD compatible
license, in Common Lisp; package state management, on FreeBSD
networks) e.g `ctrl+t` from interactive console during Poudriere build

#### When "Dependent Port Failed" ...

**Case Study:** Building `lang/gcc`

1. Study the build log

e.g file: `/usr/local/poudriere/data/logs/bulk/${JAILNAME}-${TREENAME}/${BUILD_TIMESTAMP}/logs/gcc-4.8.5.log `
>     ...
>     gmake[4]: *** [gnu/java/nio/charset.lo] Error 1
>     Makefile:10612: recipe for target 'gnu/java/security/provider.lo' failed
>     gmake[4]: *** [gnu/java/security/provider.lo] Error 1
>     Makefile:10612: recipe for target 'gnu/java/security/hash.lo' failed
>     gmake[4]: *** [gnu/java/security/hash.lo] Error 1
>     Makefile:10612: recipe for target 'gnu/java/security/sig/dss.lo' failed
>     gmake[4]: *** [gnu/java/security/sig/dss.lo] Error 1
>     Makefile:10217: recipe for target 'all-recursive' failed
>     gmake[3]: *** [all-recursive] Interrupt
>     Makefile:13160: recipe for target 'all-target-libjava' failed
>     gmake[2]: *** [all-target-libjava] Interrupt
>     Makefile:856: recipe for target 'all' failed
>     gmake[1]: *** [all] Interrupt

2. Update the port, if possible

3. Reconfigure the port

**Ed. Note:** Use the `-c` argument to the Poudriere `options` command

>     poudriere options -j ${JAIL} -p ${TREE} -c lang/gcc

**Ed. Note:** _Disabled `JAVA` option for `lang/gcc` port
configuration. _See also:_ GNU Compiler for Java (GCJ).

4. Rebuild the port

>     poudriere bulk -j ${JAIL} -p ${TREE}  -J 3 lang/gcc


5. If the build succeeds, then rebuild any dependent ports sets


#### Build Did Not Occur, "Dependent Port Ignored"

**Case study:** `audio/libsamplerate` option `CPU_CLIP`

>     ]00:07:39] ====>> [01][00:00:17] Finished build of audio/libsamplerate: Ignored: has to be built manually: CPU_CLIP may customize the package for the build machine
>     [00:07:39] ====>> [01][00:00:17] Skipping build of graphics/colord: Dependent port audio/libsamplerate ignored

**Workaround:** Reconfigure the ignored port, disabling the
problematic configuration option. Then, restart the ports build
iteration.

#### Build Did Not Occur, Port Ignored

**Case Study:** VirtualBox `emulators/virtualbox-ose-kmod`,
`emulators/virtualbox-ose-additions`


>    [00:01:23] ====>> [02][00:00:00] Starting build of emulators/virtualbox-ose-kmod
>    [00:01:24] ====>> [02][00:00:01] Finished build of emulators/virtualbox-ose-kmod: Ignored: requires kernel source files in /usr/src
>    [00:01:25] ====>> [01][00:00:02] Finished build of emulators/virtualbox-ose-additions: Ignored: requires kernel source files in /usr/src
>    [00:01:25] ====>> Stopping 2 builders

Observation: The Poudriere _Reference Jail_, built as a Poudriere
`null` jail in this example, was  not built with source files under
the process jail's `/usr/src` pathname.

*Workaround:* Create an exact copy of `/usr/src` in the null jail's
installation location.

**Ed. Note:** source tree was unchanged since host _base  system_ was
compiled and installed to location `/usr/jail/fum`

>     [user@host ~]$ poudriere jail -l
>     JAILNAME    VERSION     ARCH  METHOD TIMESTAMP           PATH
>     10-2-STABLE 10.2-STABLE amd64 null   2015-10-05 01:14:13 /usr/jails/fum
>     [user@host ~]$ cd /usr/jails/fum/usr/src && cp -a /usr/src/* . 

**To Do:** Ensure that an appropriate copy of `/usr/src` is created within the
filesystem tree for the `null` type process jail (Poudriere). Ensure,
moreover, that the copy of `/usr/src` is updated, after the jail's
filesystem tree is updated from any kernel compiled of a later source
code release.

### Failures During 'Build-depends' 

Case Study: VirtualBox

Desription of Issue: `emulators/virtualbox-ose` when configured with
`MANUAL=on` depends on `print/tex-formats`. The `print/tex-formats`
port build fails with a message about `build-depends`.

**Ed. Note:** It may seem that this particular message may indicate a
failure when building or when installing the 'build-depends' of the
denoted port.

For further information about the failure, the build's log files may
be consulted.

**Ed. Note:** The `print/tex-formats` port is a _metaport_ defined
with `NO_BUILD=yes`, `NO_INSTALL=yes`. See also: [FreeBSD Porter's Handbook](https://www.freebsd.org/doc/en/books/porters-handbook/index.html)


Reviewing the log of the `print/tex-formats` port build, at pathname
`/usr/local/poudriere/data/logs/bulk/${JAILNAME}-${TREENAME}/${BUILD_TIMESTAMP}/logs/tex-formats-${...}.log`

> Failed to install the following 1 package(s): /packages/All/texlive-texmf-20150523_3.txz

Workaround: Reconfiguring `emulators/virtualbox-ose` with `MANUAL=off`,
the build succeeds. However, other builds depending on `tex-formats`
may fail

Alternate Workaround: Build `print/tex-dvipsk`, then build
`print/tex-formats`. If build fails, review later logs

> [10-2-STABLE-granite-job-01] `-- Extracting texlive-base-20150521_6: .......... 
> done
> [10-2-STABLE-granite-job-01] Extracting texlive-texmf-20150523_3: .....
> pkg-static: archive_read_extract(): Lzma library error:  No progress is possible
> [10-2-STABLE-granite-job-01] Extracting texlive-texmf-20150523_3... done
> [10-2-STABLE-granite-job-01] Deleting files for texlive-texmf-20150523_3: .......... done
> 
> Failed to install the following 1 package(s): /packages/All/texlive-texmf-20150523_3.txz

Poroviding the `-C` argument to `poudriere bulk`, damaged distfile
archives will be removed before build

> poudriere bulk -j ${JAIL}${TREE} -C -J 3 print/texlive-texmf


## Procedure: Update Poudriere, Jail and Ports, Rebuild Packages, and Upgrade Packages on Network Hosts

Update Poudriere
>     cd /usr/ports/ports-mgmt/poudriere && make && make deinstall && make install clean

Update `${JAILNAME}` onto ports tree `${TREENAME}` - applicable for non-null Poudriere jails
>     poudriere jail -k -j ${JAILNAME} -p ${TREENAME} &&
>       poudriere jail -u -j ${JAILNAME} -p ${TREENAME};

**Ed. note:** In the previous examples, a 'null' type Poudriere jail is
appiled. Thus, at time of ports build, the Poudriere _reference jail_
will be constructed of a locally built _base system_. In a 'null' 
type Poudriere jail, the jail will not need  to be manually updated in
Poudriere. With a 'null' type Poudriere ports jail, the Poudriere
_reference jail_ will be constructed from the latest compiled base
system.

Update ports tree `${TREENAME}`

>     poudriere ports -u -p ${TREENAME}

Rebuild ports in ports tree `${TREENAME}`, using jail `${JAILNAME}`

>     # Compute list of previously built ports (Ed. note: Crude method)
>     REBUILD=$(ls /usr/local/poudriere/data/logs/bulk/${JAILNAME}-${TREENAME}/latest-per-pkg/
>                | cut -d- -f1 | sort | uniq)
>     # Ensure that the ports are named by category (Ed. note: Crude method)
>     REBUILD=$(for P in $REBUILD; do pkg rquery -e "%n = $P" '%o'; done | sort | uniq)
>     # Rebuild
>     poudriere bulk -a -j ${JAILNAME} -p ${TREENAME} ${REBUILD}

**Ed. Note:** If any of the ports' configuration data has substatially
changed across versions, then Poudriere might present a query about
new/changed configuration options, during time of `bulk` build (?)

**Ed. Note:** The previous example presents only a crude way to update
ports, in rebuilding _all previously built ports_ at time of update. A
more optimal method may be advisable for selecting the list of ports
to `${REBUILD}`, such that the list of ports to `${REBUILD}` would be
constructed only of ports updated since last build. Of course, the
implementation of such an apporach may vary by Poudriere jail method
and Poudriere port tree method. _See also:_ Poudriere metadata as
stored under`/usr/local/poudriere/data/logs/bulk/${JAILNAME}-${TREENAME}/`

**Ed. Note:** The `-a` option to `poudriere bulk` may not be
advisable for LAN-local builds. It may be advisable to build only the
ports that will be used on the LAN. Thus, in this example, the
metadata stored by Poudriere is consulted, for computing the whole set
of previously built ports. Albeit, the Poudriere metadata is consulted
without parsing the actual JSON formatted log files as generated by
Poudriere, in so much of Poudriere's processes of metadata state
recording -- thus, a "Crude method", in the example.

**Ed. Note:** Subsequently, the previous examples can be referenced
for updating packages from the local software distribution repository.

**TBD,** old versions of the updated packages may need to be 
manually pruned (?) from the package repository as Poudriere will
generate at a pathanme
`/usr/local/poudriere/data/packages/${JAILNAME}-${TREENAME}/`


## Topic: Building from Locally Customized Ports

**Usage Case:** Building prototypes for testing, when updating
upstream ports to current release versions of upstream software.

**Concept:** Git as a distrubted SCCM

**Concept:** Patching ports -- for port update, other local
modifications, ...
* Topic: Git 'pull' requests


## Topic: Building as a Non-Root User

The poudriere `queue` command

## Topic: Monitoring the Poudriere Build

* Topic: Poudriere Build Logs
    * Pathname pattern: `/usr/local/poudriere/data/logs/bulk/${JAILNAME}-${TREENAME}/latest-per-pkg/`
* See also: [hooks](https://github.com/freebsd/poudriere/wiki/hooks)

## Topic: Defining 'Build Sets' for Poudriere

The _Autoports_ project, as well as developing this rudimentary
documentation, furthermore develops a concept of _Build sets_ for
coordination of bulk port builds with Poudriere.

## Topic: ...

* `poudriered` and `poudriere queue` (since Poudriere 3.1)
