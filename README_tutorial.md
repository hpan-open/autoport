
# Notes

## Overview - Why Local Ports

* Optimized `/etc/make.conf`
    * Processor-specific optimizations
    * Debug Options

* Custom Package Configuration

* Institution-Local Licensing for Non-Redistributable Packag
    * e.g. Adobe Flash; Microsoft fonts; 'trial' software in ports

* Contextual topics
    * Shell Console
        * `screen`
    * FreeBSD `pkgng`
        * Configuring `pkgng`
        * Querying package metadata with `pkg query` and `pkg rquery`
    * Software Distribution in FreeBSD
        * FreeBSD Ports
            * Ports and Software Licensing
        * FreeBSD Base System
        * FreeBSD Kernel
    * FreeBSD Process Jails
        * Jail Configuration and Management with `ezjail`
    * Poudriere
        * Poudriere Configuration
        * Poudriere _reference jail_ (build-time jail)
        * Metadata Generated by Poudriere

## Topic: Poudriere Metadata

## Procedure : Create Local Jail for Initial Port Builds, Poudriere Runtime

**References**
* [Managing Jails with ezjail](https://www.freebsd.org/doc/handbook/jails-ezjail.html)
* [ezjail homepage](https://erdgeist.org/arts/software/ezjail/)
* [Appserver Jails HOWTO](https://wiki.freebsd.org/AppserverJailsHOWTO)
* [Run poudriere in a jail](https://github.com/freebsd/poudriere/wiki/poudriere_in_jail)

**Ed. Note:** It may be convenient to use `screen` when administering
a host. See also: port `sysutils/screen`; `screen` TeXinfo pages

**Example: Initialize a `screen` service** as named for the host's _node name_
>     screen -S $(hostname -s)

**Example: Reconnect to a running `screen` service** named for he host's _node name_
>     screen -xr $(hostname -s)

**Ed. Note:** If `/usr/local/poudriere` is mounted as an NFS share in
any peers on the LAN, it may be advisable for the peers to unmount the
share before any packages will be built with Poudriere.

**Ed. Note:** The following text about ezjail might be a useful
summary, though not going into detail about launching Poudriere from
within the created jail. See also: References

First, **define `lo` as a _cloned interfce** -- configure `rc.conf`
for `cloned_interfaces="lo1"`**, then `service netif cloneup` 

Secondly, **update the system ports tree** (`portsnap`) 

>     cd /usr/src
>     portsnap fetch
>     portsnap update

If needed, **rebuild the system's pkgng**

>     cd /usr/ports/ports-mgmt/pkg
>     make
>     make deinstall
>     make install clean

**Build and install ezjail**

>     cd /usr/ports/sysutils/ezjail
>     make install clean

Optionally, **enable ezjail initialization at boot time, and start
ezjail** -- configure `rc.conf` for `ezjail_enable="YES"` and `service
ezjail start`

**Build the _basejail_** for the host -- to `/usr/jails/fulljail` from
`/usr/src` (as previously a `make installworld` source)

>     ezjail-admin update -i -p

**Ed. note:** _This takes a short while_

**Create a jail for use by Poudriere** (non-ZFS), at `/usr/jails/portjail`

>     ezjail-admin create portjail 'lo1|127.0.0.1,em0|192.168.100.50'

Ed. Note: ... _sshd, ntpd, syslogd_ ... _PF_ ...

**Ed. Note:** ezjail can be useful for managing jails in which to run
Poudriere, albeit perhaps not as useful for managing jails used by
Poudriere for port building.


## Procedure: Simple Local Build Process with Poudriere

**Creating a jail source for Poudriere build-time jails**

**Ed note:** A FreeBSD _base system_ was previously built in `/usr/src`

>     cd /usr/src
>     make installworld DESTDIR=/usr/jails/pjail DB_FROM_SRC=1
>     make distrib-dirs DESTDIR=/usr/jails/pjail DB_FROM_SRC=1
>     make distribution DESTDIR=/usr/jails/pjail DB_FROM_SRC=1


**Initialize the jail with Poudriere**

>     VERSION=$(uname -r)
>     JAILNAME=$(echo $VERSION | sed 's|\.|-|')
>     poudriere jail -c -j ${JAILNAME} -v ${VERSION} -m null -M /usr/jails/pjail

_Ed. Note:_ The jail created in this step will be used as a source for
initializing a Poudriere _reference jail_, at build time

**Initialize a ports tree with Poudriere**, using the 'git' ports method

>     TREENAME="$(hostname -s)"
>     poudriere ports -c -p ${TREENAME} -m git

Ports tree will be cloned to "/usr/local/poudriere/ports/${TREENAME}"

**Ed. note:** _This takes a short while_

**Create a list of packages to build**

>     cat<<EOF>> my.list
>     misc/mmv
>     sysutils/less
>     sysutils/xstow
>     sysutils/screen
>     EOF

**Configure packages from list**

>     poudriere options -p ${TREENAME} -j ${JAILNAME} -f my.list

**Ed. note:** Some configuration options may result in selection of
additional dependencies, thus requiring later configuration dialogues

**Build Packages from list**, Three parallel builds

>     poudriere bulk -p ${TREENAME} -j ${JAILNAME} -f my.list -J 3 -C

**Ed. note:** distfiles retrieved from `MASTER_SITES`

**Ed. note:** Files will be created at  `"/usr/local/poudriere/data/packages/${JAILNAME}-${TREENAME}"`

**Ed. note:** See also `pkg.conf(5)`

>     mkdir -p /usr/local/etc/pkg/repos
>     REPNAME=${TREENAME}
>     CONF=/usr/local/etc/pkg/repos/${TREENAME}.conf
>     PKGPATH=/usr/local/poudriere/data/packages/${JAILNAME}-${TREENAME}
>     if ! [ -a ${CONF} ]; then
>       cat <<EOF> ${CONF}
>     ${REPNAME} {
>        url: "file://${PKGPATH}"
>        priority: 10
>     }
>     EOF

...

**Option:** Install from list in build log

**Ed note:** In this approach, every package installed will be marked as
_manually installed_. Thus, none of the packages may be subsequently
removed with `pkg autoremove`

>     export ASSUME_ALWAYS_YES=yes
>     PKGS=$(awk '{print $1}' /usr/local/poudriere/data/logs/bulk/${JAILNAME}-${TREENAME}/latest/.poudriere.ports.built)
>     pkg install -f ${PKGS}


**Alternate approach :** Reinstall all packages currently installed
from repository `${REPNAME}`

**Ed note:** Assuming that the `install -f` command may alter some
_packge state_ data as would otherwise be available to `pkg
autoremove`, the following script ensures that the _autoremove_ state
will be restored onto any packages reinstalled with the script

**Ed. note:** FIXME - List sorting/deduplication would be easier in
Lisp. See also: ECL

**Ed. note:** If package dependencies change across the reinstallation
process, the subsequent `pkg set` call might fail.
 
>     export ASSUME_ALWAYS_YES=yes
>     # Set IFS to a custom value, to ensure newlines are not
>     # collapsed to spaces in varibles
>     if [ -v IFS ]; then ORIG_IFS=${IFS}; else unset ORIG_IFS; fi
>     IFS=*
>     PKGS_IN=$(pkg query '%n')
>     PKGS_AUTO=$(pkg query -e '%a = 1' '%n')
>     PKGS=$({ echo ${PKGS_IN} && pkg rquery -r ${REPNAME} '%n'; }  | sort | uniq -d)
>     PKGS_REAUTO=$({ echo ${PKGS_AUTO} && echo ${PKGS}; } | sort | uniq -d)
>     # Update pkgng Repository Information and Re-Install Packages
>     export PKGS PKGS_REAUTO
>     su
>     pkg update && pkg install -f ${PKGS}
>     # Ensure 'autoremove' flag is still set on original 'autoremove' packages
>     for P in ${PKGS_REAUTO}; do pkg set -A 1 ${P}; done
>     # Reset IFS
>     if [ -v ORIG_IFS ]; then IFS=${ORIG_IFS}; unset ORIG_IFS; else unset IFS; fi

## Procedure: Update Poudriere, Jail and Ports, Rebuild Packages, and Upgrade Packages on Network Hosts

Update Poudriere
>     cd /usr/ports/ports-mgmt/poudriere && make && make deinstall && make install clean

Update `${JAILNAME}` onto ports tree `${TREENAME}` - applicable for non-null Poudriere jails
>     poudriere jail -k -j ${JAILNAME} -p ${TREENAME} &&
>       poudriere jail -u -j ${JAILNAME} -p ${TREENAME};

**Ed. note:** In the previous examples, a 'null' type Poudriere jail is
appiled. Thus, at time of ports build, the Poudriere _reference jail_
will be constructed of a locally built _base system_. In a 'null' 
type Poudriere jail, the jail will not need  to be manually updated in
Poudriere. With a 'null' type Poudriere ports jail, the Poudriere
_reference jail_ will be constructed from the latest compiled base
system.

Update ports tree `${TREENAME}`

>     poudriere ports -u -p ${TREENAME}

Rebuild ports in ports tree `${TREENAME}`, using jail `${JAILNAME}`

>     # Compute list of previously built ports (Ed. note: Crude method)
>     REBUILD=$(ls /usr/local/poudriere/data/logs/bulk/${JAILNAME}-${TREENAME}/latest-per-pkg/
>                | cut -d- -f1 | sort | uniq)
>     # Ensure that the ports are named by category (Ed. note: Crude method)
>     REBUILD=$(for P in $REBUILD; do pkg rquery -e "%n = $P" '%o'; done | sort | uniq)
>     # Rebuild
>     poudriere bulk -a -j ${JAILNAME} -p ${TREENAME} ${REBUILD}

**Ed. Note:** If any of the ports' configuration data has substatially
changed across versions, then Poudriere might present a query about
new/changed configuration options, during time of `bulk` build (?)

**Ed. Note:** The previous example presents only a crude way to update
ports, in rebuilding _all previously built ports_ at time of update. A
more optimal method may be advisable for selecting the list of ports
to `${REBUILD}`, such that the list of ports to `${REBUILD}` would be
constructed only of ports updated since last build. Of course, the
implementation of such an apporach may vary by Poudriere jail method
and Poudriere port tree method. _See also:_ Poudriere metadata as
stored under`/usr/local/poudriere/data/logs/bulk/${JAILNAME}-${TREENAME}/`

**Ed. Note:** The `-a` option to `poudriere bulk` may not be
advisable for LAN-local builds. It may be advisable to build only the
ports that will be used on the LAN. Thus, in this example, the
metadata stored by Poudriere is consulted, for computing the whole set
of previously built ports. Albeit, the Poudriere metadata is consulted
without parsing the actual JSON files as generated by Poudriere, in so
much of Poudriere's processes of metadata state recording -- thus, it
is denoted as a "Crude method", in the example.

**Ed. Note:** Subsequently, the previous examples can be referenced
for updating packages from the local software distribution repository.

## Topic: Building from Locally Customized Ports

**Usage Case:** Building prototypes for testing, when updating
upstream ports to current release versions of upstream software.

## Topic: Building as a Non-Root User

The poudriere `queue` command

## Topic: Monitoring the Poudriere Build

* Topic: Poudriere Build Logs
    * Pathname pattern: `/usr/local/poudriere/data/logs/bulk/${JAILNAME}-${TREENAME}/latest-per-pkg/`
* See also: [hooks](https://github.com/freebsd/poudriere/wiki/hooks)

## Topic: Defining 'Build Sets' for Poudriere

The _Autoports_ project, as well as developing this rudimentary
documentation, furthermore develops a concept of _Build sets_ for
coordination of bulk port builds with Poudriere.

